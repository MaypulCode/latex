# データフローと処理サイクル

## タイムステップ処理

タイムステップ $t$ におけるシミュレーションサイクル:

```
┌─────────────────────────────────────────────────────────┐
│  1. トラフィック到着処理                                 │
│     - 新しいパケットをUEバッファに追加                   │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│  2. 期限切れパケット削除                                 │
│     - deadline_step を過ぎたパケットをドロップ           │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│  3. セルメトリクス計算                                   │
│     - 各セルの需要量、平均CQI、RBあたりデータ量          │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│  4. 周波数共用でRB割当決定                               │
│     - SpectrumSharing.allocate() 呼び出し                │
│     - マクロ/マイクロへのRB数を決定                      │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│  5. 送信電力更新（必要な場合）                           │
│     - CQIを再計算                                        │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│  6. スケジューリングと送信                               │
│     - 各UEにRBを割当                                     │
│     - バッファからデータをデキュー                       │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│  7. 統計更新                                             │
│     - 送信ビット数、RB使用率などを記録                   │
└─────────────────────────────────────────────────────────┘
```

---

## データの流れ

### 入力データ

```
データセット
    │
    ├── traffic.parquet → パケット到着イベント
    ├── channel.parquet → UEのCQI/SINR
    └── environment.parquet → UE位置
```

### 中間データ

```
シミュレーション中
    │
    ├── UEバッファ → 送信待ちパケット
    ├── CellMetrics → セルごとの需要/CQI
    └── AllocationResult → RB割当結果
```

### 出力データ

```
結果
    │
    └── Metrics → 評価指標（CSV出力）
```

---

## 関連ドキュメント

- [実装設計: engine](../design/engine.md) - Simulator 実装詳細
